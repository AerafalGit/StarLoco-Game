local map = MapDef(
        9788,
        "0706131721",
        "6F7E4E563524615A4A73694C784D49243D43425270253262253262456676426A366C5C432A37757623226720497B583F482A227B21502F6C714C7B2532622656606B566957317D6D5C466C2A695D5B2532355C3B5A2F614047512238587B6868276A2F253262525326506B34246D7D253235202C22484637642A6B56236E662A342A4C264E5F6963483D237B76576D7462332532354722643A44597E75305B29786762703A4B545C47",
        "HhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaZ6HhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaZAHhK8eaaaaaGhaaeaaaZ7HhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaZAHhK8eaaaaaHhGaeaaaaaGhaaeaaaZ7HhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaGhaaeaaaZ7HhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaZAHhGaeaaaaaHhGaeaaaaaHhK8eaaaaaGhaaeaaaZ7HhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaGhe8eaaaZ7HhaaeaaaaaHhaaeaaaaaHhaaeaaaZAHhK8eaaaaaGhaaeaaaZvHhK8eaaaaaHhGaeaaaaaGhaaeaaaZ7HhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaGhaaeaaaZ7HhaaeaaaaaHhaaeaaaZAHhGaeaaaA6HhGaeaaaaaHhaaeaaaaaHhGaeaaaaaHhK8eaaaaaGhaaeaaaZ7HhaaeaaaaaHhaaeaaaaaHhaaeaaaZAHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaGhe8eaaaZ7HhaaeaaaZAHhK8eaaaA6HhGaeaaaaaHhe8eaaaZxHhGaeaaaaaHhK8eaaaaaHhGaeaaaA6GhaaeaaaZ7HhaaeaaaaaHhe8eaaaZAHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaGhaaeaaaZWHhaaeZUaZRHhGaeaaaaaHhGaeaaaaaHhGaeaaaaaHhGaeaafUaHhGaeaaaaaHhK8eaaaA5GhaaeaaaZ7HhaaeaaaZAHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhe8eaaaZQHhGaeaaaA5HhK8eaaaAYHhGaeaaaaaHhK8eaaaaaHhaaeaaaaaHhK8eaaaaaHhaaeaaaZRGhe8eaaaZXHhaaeaaaaaHhaaeaaaaaHhGaeaaaA6HhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhGaeaaaaaHhGaeaaaaaHhGaeaaaaaHhGaeaaaaaHhaaeaaaZxGhaaeaaaZvHhK8eaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhGaeaaaA5HhGaeaaaA5GhaaeaaaAWHhaaeaaaaaHhffgaaaaaHhK8eaaaaaHhGaeaaaaaHhK8eaaaaaHhGaeaaaaaHhK8eaaaaaHhGaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaA6HhK8eaaaaaHhGaeaaaaaHhaaeaaaaaHhffgaaaaaHhK9gaaaaaHhGaeaaaaaHhGaeaaaaaHhGaeaaaaaHhGaeaaaaaHhK8eaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhGaeaaaaaHhGaeaaaaaHhGaeaaaaaHhffgaaaaaHhLlgaaaaaHhaaeaaaaaHhK8eaaaaaHhGaeaaaaaHhK8eaaaaaHhGaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhe8eaaaaaHhGaeaaaaaHhK8eaaaaaHhfdgaaaaaHhLlgaaaaaHhaaeaaaaaHhK9gaaaaaHhGaetCaaaHhGaeaaaaaHhK8eaaaaaHhK7eaaaaaHhfdeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhqaeqgaaaHhGaeaaaaaHhfdgaaaaaHhLlgaaaaaHhLlgaaaaaHhLlgaaaaaHhaaeaaeZ8HhK8etCaaaHhGaeaaaaaHhK7eaaaaaHhLkeaaaaaHhfdeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhK8eaaaaaHhK7eaaaaaHhLlgaaaaaHhLlgaaaaaHhLlgaaaaaHhaaeaaaaaHhaaeaaaaaHhe8eaaaZzHhaaeaaaZ8HhLkeaaaaaHhLkeaaaaaHhffeaaaaaHhaaeaaaaaGhaaeaaaZHHhGaeaaet0HhK7eaaaaaHhLkeaaaaaHhLlgaaaaaHhLlgaaaaaHhaaeaaeZ8HhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhLkeaaaaaHhLkeaaaaaHhffeaaaaaGhaaeaaaZHHhe8eaaaZQHhaaeaaaZ8HhLkeaaaaaHhLlgaaaaaHhLlgaaaaaHhaaeaaeZ_HhaaeaaaaaHhaaeaaaaaHhaaeasaaaHhaaeaaaaaHhaaeaaaZ8HhLkeaaaaaHhLkeaaaaaGhaaeaaaZHHhe8eaaaA5HhaaeaaaaaHhaaeaaaZ8HhLkeaaaaaHhLlgaaaAXHhLlgaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaZ8HhLkeaaaaaHhGaeaaaaaHhGaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaZ_HhLlgaaaaaHhLlgaaaaaGhaaeaaaZvHhaaeaaaaaHhaaeaaaaaHhaaeasaaaHhLneaaaaaHhaaeaaaaaHhaaeaaaZ_HhGaeaaaaaHhK8eaaaaaHhaaeaaaAXHhaaeaaaaaHhaaeaaaaaHhLlgaaaaaHhLlgaaaaaHhGaeaaaaaHhGaeaaaaaHhaaeaaaaaHhaaeaaaaaHhGaeaaaaaHhGaeaaaaaHhaaeaaaaaHhaaeaaaZOHhGaeaaaaaHhqaeqgaaaHhaaeaaaaaHhaaeaaaaaHhLlgaaaaaHhLlgaaaaaHhGaeaaaaaHhK8eaaaaaHhGaeaaaaaHhaaeaaaaaHhaaeaaaaaHhGaeaaaaaHhffeaaaaaHhaaeaaaaaHhK8eaaaaaHhGaeZ3aaaHhe8eaaaaaHhaaeaaaaaHhaaeaaaZ8HhLlgaaaaaHhGaeaaaaaHhK8eaaaaaHhGaeaaaaaHhGaeaaaaaHhaaeaaaaaHhaaeaaaaaHhK7eaaaaaHhfdeaaaaaHhaaeaaaaaHhGaetCaaaHhGaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaZ8HhGaeaaaaaHhGaeaaaaaHhaaeaaaaaHhK8eaaaaaHhGaeaaaA6HhaaeaaaaaHhaaeaaaZ8HhLkeaaaaaHhffeaaaaaHhaaeZ5aaaHhK8eaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhGaeaaaA6HhK8eaaaaaHhaaeaaaaaHhaaeaaaaaHhK8eaaaaaHhGaeaaaA6HhaaeaaaaaHhaaeaaaZ_HhLkeaaaaaHhfdeaaaaaHhaaeaaaaaHhGaeaaat0HhaaeaaaaaHhaaeaaaaaGhaaeaaaZvHhGaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhGaeaaaaaGhaaeaaaZvHhaaeaaaaaHhaaeZ5aZ8HhLkeaaaaaHhaaeaaaaaHhaaeaaaaaHhe8eaaaaaHhaaeaaaaaHhaaeaaaaaHhe8eaaaZQHhGaeaaaaaHhaaeaaaaaHhaaeaaaaaHhGaeaaaaaHhK8eaaaA6HhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhGaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhGaeaaaA5HhGaeaaaaaHhfoeaaaaaHhGaeaaaaaHhK8eaaaaaHhffeaaaaaHhaaeaaaaaHhaaeaaaaaHhGaeaaaaaHhGaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhK8etCaA5HhGaeaaaaaHhGaeaaaaaHhGaeaaaaaHhK7eaaaaaHhffeaaaaaHhaaeaaaaaHhaaeaaaaaHhK8eaaaaaHhaaeaaaaaHhaaeaaaaaGhaaeaaaAZHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhGaeaaaaaHhGaeaaaaaHhK8eaaaaaHhK7eaaaaaHhLkeaaaaaHhfdeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeZ5aaaHhK8eaaaaaHhGaeaaaaaHhK7eaaaaaHhLket0qaaHhvkeqgaaaHhfdeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaGhe8eaaaZvHhaaeaaaZ8HhfkeaaaaaHhfkeaaaaaHhfkeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaaHhaaeaaaaa",
        15,
        17,
        -3,
        24,
        314
)

map.positions = "c_dndBdSd6eiewfsfGfU|cMcNcOeGe9fAgogRhi"
map.capabilities = 4
map.mobGroupsCount = 3
map.mobGroupsMinSize = 8
map.allowedMobGrades = {
    {82, 1},
    {82, 2},
    {82, 3},
    {82, 4},
    {82, 5},
    {95, 1},
    {95, 2},
    {95, 3},
    {95, 4},
    {95, 5},
    {94, 1},
    {94, 2},
    {94, 3},
    {94, 4},
    {94, 5},
    {853, 1},
    {853, 2},
    {853, 3},
    {853, 4},
    {853, 5},
    {862, 1},
    {862, 2},
    {862, 3},
    {862, 4},
    {862, 5},
    {885, 1},
    {885, 2},
    {885, 3},
    {885, 4},
    {885, 5},
    {89, 1},
    {89, 2},
    {89, 3},
    {89, 4},
    {89, 5},
}

local sanctuaryKeyId = 8342
local dungeonKeyId = 8343

local function tryEntering(_, _, p, targetCell)
    -- Player needs the dungeon keychain or key AND either the sanctuary keychain or key
    local hasDungeonKey = p:getItem(dungeonKeyId) or hasKeyChainFor(p, dungeonKeyId)
    local hasMazeKeyOrKeyChain = p:getItem(sanctuaryKeyId) or hasKeyChainFor(p, sanctuaryKeyId)

    if not hasDungeonKey or not hasMazeKeyOrKeyChain then
        -- Should not happen (cheat?)
        return
    end

    local usedKeychain = false

    -- Try to use the keychain for the sanctuary key first
    if hasKeyChainFor(p, sanctuaryKeyId) then
        usedKeychain = useKeyChainFor(p, sanctuaryKeyId)
    end

    -- If the keychain was not used, try to consume the sanctuary key
    if not usedKeychain then
        if not p:consumeItem(sanctuaryKeyId, 1) then
            -- Should not happen (cheat?)
            p:endDialog()
            return
        end
    end

    -- Try to use the keychain for the dungeon key
    if hasKeyChainFor(p, dungeonKeyId) then
        usedKeychain = useKeyChainFor(p, dungeonKeyId)
    end

    -- If the keychain was not used, try to consume the dungeon key
    if not usedKeychain then
        if not p:consumeItem(dungeonKeyId, 1) then
            -- Should not happen (cheat?)
            p:endDialog()
            return
        end
    end

    -- Teleport the player
    if targetCell == 110 then
        p:teleport(10098, 407)
    elseif targetCell == 125 then
        p:teleport(10098, 425)
    end
    p:endDialog()
end

local function onPlayerMove(_, _, p)
    if p:cell() == 110 then
        tryEntering(_, _, p, 110)
    elseif p:cell() == 125 then
        tryEntering(_, _, p, 125)
    end
end

map.onMovementEnd = {
    [218] = moveEndTeleport(9822, 274),
    [318] = moveEndTeleport(9801, 117),
    [458] = moveEndTeleport(9831, 35),
    [110] = onPlayerMove,
    [125] = onPlayerMove
}

RegisterMapDef(map)
